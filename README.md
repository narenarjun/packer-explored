# Packer Explored

[Packer](https://www.packer.io) is an open source tool from [hashicorp](https://www.hashicorp.com/) for creating identical machine images for multiple platforms [like aws, azure, gcp, docker ,...etc]  from a single source configuration.
Packer configuration is written in JSON and as of v1.5 hcl2 is supported {still some features are under implementation stage}.

## Installation

[Packer CLI](https://www.packer.io/downloads) is available for all major platforms and can be downloaded from [here](https://www.packer.io/downloads)

## ENV variables & credentials

AWS Access Key and AWS Secret Key are set in environment variable.

```bash
$ export AWS_ACCESS_KEY_ID="anaccesskey"
$ export AWS_SECRET_ACCESS_KEY="asecretkey"

```

> ### Note:
> Setting your AWS credentials using either the above environment variables will override the use of `AWS_SHARED_CREDENTIALS_FILE` and `AWS_PROFILE`.


## Building 

`packer build <filename>` will start building the machine image.

> Note:
>   when tried to build image with hcl template file, the image was not created and the cli didn't throw error too. just exited with `no resource created` shell output. JSON format works properly.

### Converting JSON to HCL2

Packer comes with a `hcl2_upgrade` cli option to convert `json` file into `hcl2` format. 

```bash
packer hcl2_upgrade -output-file=name.pkr.hcl filename.json
```
> Note:
>   packer build worked fine when using the autogenerated hcl file from json.


## [Provisioners](https://www.packer.io/docs/provisioners)

[Provisioners](https://www.packer.io/docs/provisioners) use builtin and third-party software to install and configure the machine image after booting. Provisioners prepare the system for use, so common use cases for provisioners include:

  -  installing packages
  -  patching the kernel
  -  creating users
  -  downloading application code

in template code:
```json
{
  "provisioners": [
    // ... one or more provisioner definitions here
  ]
}
```

## [Post-Processors](https://www.packer.io/docs/post-processors)

[Post-processors](https://www.packer.io/docs/post-processors) run after the image is built by the builder and provisioned by the provisioner(s). Post-processors are optional, and they can be used to upload artifacts, re-package, or more.

in template code :
```json
{
  "post-processors": [
    // ... one or more post-processor definitions here
  ]
}
```

## Debugging 

[Breakpoint Provisioner](https://www.packer.io/docs/provisioners/breakpoint#breakpoint-provisioner) is a special and useful provisoner which will 
pause until "enter" key is pressed to resume the build
can be used to halt at a particular part of the provisioning process ,it is intented for debugging purpose and it is independent of `-debug` flag {which will instead halt at every step and between every provisioner}.

```json
{
  "builders": [
    {
      "type": "null",
      "communicator": "none"
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "inline": "echo hola"
    },
    {
      "type": "breakpoint",
      "disable": false,
      "note": "this is a breakpoint"
    },
    {
      "type": "shell-local",
      "inline": "echo bonjour"
    }
  ]
}
```
